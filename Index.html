<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
  <style>
    #loading {
      display: none;
      text-align: center;
    }
  </style>
  <script>
    
    let currentFolderId = null; // null: root
    let selectedFolderId = null;
    let duplicateFolderId = null;
    let duplicateFolderPath = null;
    let keepFileFolders = [];
    let keepAccessFolders = [];
    let loadingCalls = 0;
    function checkIfLoadingComplete() {
      loadingCalls++;
      if (loadingCalls === 2) {
        $("#loading").hide();
        $("#folders").show();
        $('#confirmSelectBtn').show();
        loadingCalls = 0;
      }
    }
    function listFolders() {
      // based on current folder ID to retrieve the folders
      $("#folders").hide();
      $('#confirmSelectBtn').hide();
      $("#loading").show();
      // call server-side functions to list folders within the current folder, generate folder path
      google.script.run.withSuccessHandler(displayFolders).getFoldersInFolder(currentFolderId);
      google.script.run.withSuccessHandler(displayPath).getFolderPath(currentFolderId);
    }
    
    function displayFolders(folderList) {
      // clear displayed folders, display folders in the fold click selection area
      let folderListParsed = JSON.parse(folderList);
      let folderContainer = $("#folders");
      folderContainer.empty();
      // add folders
      folderListParsed.forEach(function(folder) {
        folderContainer.append(
          `<li class="list-group-item" onclick="navigateFolder('${folder.id}', this)">${folder.name}</li>`
        );
      });
      // loading check
      checkIfLoadingComplete();
    };

    function displayPath(pathList) {
      // display a path string
      pathList = JSON.parse(pathList);
      let pathContainer = $("#path");
      pathContainer.empty();
      let pathStr = pathList.map(folder => folder.name).join("/");
      pathContainer.text(pathStr);
      // loading check
      checkIfLoadingComplete();
    }

    function navigateFolder(folderId, element) {
      // one-click: update selected folder
      // two-click: navigate into the selected folder
      if (selectedFolderId === folderId) {
        currentFolderId = folderId;
        listFolders();
      } else {
        selectedFolderId = folderId;
        $("#folders .list-group-item").removeClass('active');
        $(element).addClass("active");
        // console.log("Current selected folder: %s %s", $(element).text(), selectedFolderId);
        $("#selectedFolder").text("Selected folder: " + $("#path").text() + "/" + $(element).text());
      }
    }

    function navigateUp() {
      if (currentFolderId) {
        // if selected the folder to duplicate and it's the current folder
        if (duplicateFolderId && duplicateFolderId === currentFolderId) return;
        $("#folders").hide();
        $('#confirmSelectBtn').hide();
        $("#loading").show();
        google.script.run.withSuccessHandler(function(pathList) {
          pathList = JSON.parse(pathList);
          if (pathList.length > 1) {
            let pathStr = pathList.map(folder => folder.name).join("/");
            if (duplicateFolderId){
              // outside the selected duplication folder, go inside the duplication folder
              if (pathStr.indexOf(duplicateFolderPath) < 0){
                currentFolderId = duplicateFolderId;
                listFolders();
                return;
              }
            }
            // can navigate outside
            if ( pathList.length > 1){
              currentFolderId = pathList[pathList.length - 2].id;
              listFolders();
            }
            else{
              $("#folders").show();
              $('#confirmSelectBtn').show();
              $("#loading").hide();
            }
          }
          // else {
          //   currentFolderId = null;
          //   listFolders();
          // }
        }).getFolderPath(currentFolderId);
      }
    }

    function confirmDuplicationSelection() {
      // confirm the folder to be duplicated, prepare for adding file folders
      duplicateFolderPath = $("#selectedFolder").text().replace("Selected folder: ", "");
      duplicateFolderId = selectedFolderId;
      alert("Selected folder to be duplicated: " + duplicateFolderPath);
      $("#promptMessage").text("Select subfolders to maintain files.");
      $('#addBtn').show();
      $('#addBtn').on('click', addFileFolder);
      $('#confirmSelectBtn').off('click');
      $('#confirmSelectBtn').on('click', confirmFileFolderSelect);
      // navigate into the selected duplication folder
      currentFolderId = duplicateFolderId;
      listFolders();
    }
    
    function confirmFileFolderSelect() {
      // confirm the folders to keep files, prepare for adding access folders
      alert('confirmed file folders');
      console.log(keepFileFolders);
      $("#promptMessage").text("Select subfolders to maintain access.");
      $('#addBtn').show();
      $('#addBtn').off('click');
      $('#addBtn').on('click', addAccessFolder);
      $('#confirmSelectBtn').off('click');
      $('#confirmSelectBtn').on('click', confirmAccessFolderSelect);
    }

    function confirmAccessFolderSelect() {
      // Final confirmation and display of all selections
      $('#folderSelectContainer').remove();
      let finalSubmissionContainer = $('#finalSubmission');
      
      finalSubmissionContainer.append('<h2>Selected Folders</h2>');
      
      finalSubmissionContainer.append(`<p>Folder to be duplicated: ${duplicateFolderPath}</p>`);

      // folders to keep files and access
      finalSubmissionContainer.append('<h3>Folders to keep files:</h3>');
      let fileFolderList = $('<ul class="list-group"></ul>');
      keepFileFolders.forEach(folder => {
        fileFolderList.append(`<li class="list-group-item">${folder.path}</li>`);
      });
      finalSubmissionContainer.append(fileFolderList);
      
      finalSubmissionContainer.append('<h3>Folders to keep access:</h3>');
      let accessFolderList = $('<ul class="list-group"></ul>');
      keepAccessFolders.forEach(folder => {
        accessFolderList.append(`<li class="list-group-item">${folder.path}</li>`);
      });
      finalSubmissionContainer.append(accessFolderList);
      finalSubmissionContainer.append('<button id="submitBtn" class="btn btn-success">Submit</button>');
      // append a submit button and a reset button
      return;

    }
    
    function addAccessFolder() {
     // add a folder to keep the access
      const folder = {
          "id": selectedFolderId,
          "path": $("#selectedFolder").text().replace("Selected folder: ", ""),
      }
      if (folder.id === duplicateFolderId) {
        alert("Same folder!");
        return;
      }
      if (folder.path.indexOf(duplicateFolderPath) != 0) {
        alert("Wrong folder!");
        return;
      }
      for (let i=0; i<keepAccessFolders.length; i++) {
        if (keepAccessFolders[i].id === folder.id){
          alert("Folder already added.")
          return;
        }
      }
      keepAccessFolders.push(folder);
      console.log("Folder added successfully.")
    }


    function addFileFolder() {
      // add a folder to keep the files
      const folder = {
          "id": selectedFolderId,
          "path": $("#selectedFolder").text().replace("Selected folder: ", ""),
      }
      if (folder.id === duplicateFolderId) {
        alert("Same folder!");
        return;
      }
      if (folder.path.indexOf(duplicateFolderPath) != 0) {
        alert("Wrong folder!");
        return;
      }
      for (let i=0; i<keepFileFolders.length; i++) {
        if (keepFileFolders[i].id === folder.id){
          alert("Folder already added.")
          return;
        }
      }
      keepFileFolders.push(folder);
      console.log("Folder added successfully.")
    }

    $(document).ready(function() {
      listFolders();
      $("#promptMessage").text("Select a folder to be duplicated.");
      $('#confirmSelectBtn').on('click', confirmDuplicationSelection);
      $('#addBtn').hide();
      $('#confirmSelectBtn').hide();
    });
  </script>
</head>
<body>
  
  <div id="folderSelectContainer" class="container">
    <h2 id="promptMessage"></h2>
    <div class="mb-3">
      <button class="btn btn-primary" onclick="navigateUp()">Up</button>
    </div>
    <div id="path" class="mb-3"></div>
    <div id="loading">Loading...</div>
    <ul id="folders" class="list-group"></ul>
    <div class="mt-3">
      <div id="selectedFolder" class="mb-3"></div>
      <button id="addBtn" class="btn btn-primary">Add folder</button>
      <button id="confirmSelectBtn" class="btn btn-success">Confirm Selection</button>
      
    </div>
  </div>
  <div id="finalSubmission" class="container"></div>
  <div id="cancelContainer" class="container mt-4">
    <button id="resetBtn" class="btn btn-danger pt-2">Reset</button>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
</body>
</html>
